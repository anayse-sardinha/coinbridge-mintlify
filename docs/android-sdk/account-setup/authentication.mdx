# SDK Authentication

> Use this guide to synchronize your end-users with the CoinBridge ecosystem using JSON Web Tokens (JWT).

## Overview

Authentication (often referred to as **Auth**) correlates and synchronizes a unique user identifier across three layers:
1. Your mobile application's **CoinBridge SDK** instance.
2. The **CoinBridge Backend** platform.
3. Your own **loyalty or user management platform** via webhooks.

This process ensures that every transaction is securely mapped to the correct user account and that digital assets (points/rewards) are retrieved accurately.

---

## 1. Prerequisites

Before starting the authentication flow, ensure you have completed the following:
* **Application Key:** Obtained from the CoinBridge system.
* **RSA Key Pair:** You must generate a unique RSA key pair (at least 2048-bit). Provide the public key to CoinBridge and keep the private key secure on your backend.
* **Backend JWT Generation:** Your backend must be capable of generating and signing JWTs using the `RS256` algorithm.

---

## 2. Authentication Flow

The authentication process is a "Pre-Payment" requirement. You must verify the authentication status every time the application starts or returns from the background.


### Step 1: Check Current Status
Call the `isAuthenticated` method to determine if a valid session already exists on the device.

* **If `True`:** The SDK is already authenticated. Proceed directly to **Initialization**.
* **If `False`:** The SDK does not recognize the user/device. You must proceed with the authentication steps below.

### Step 2: Generate a JWT (Backend Only)
Your backend must generate a JWT to identify the user. 
> **Security Note:** Never generate or store private keys in the mobile application. JWT generation must happen on the server side.

#### JWT Header
```json
{
  "alg": "RS256",
  "typ": "JWT"
}
```

### JWT Payload Requirements
The JWT payload should contain the following entries to ensure the CoinBridge SDK can correctly identify the user and validate the security token:

| Claim | Description | Required Value |
| :--- | :--- | :--- |
| `jti` | **JWT ID** | A unique ID for this specific JWT. |
| `iat` | **Issued At** | Unix time (in seconds) the JWT was issued. |
| `exp` | **Expiration** | Unix time. Must be no later than **2 minutes** after the `iat` time. |
| `aud` | **Audience** | Must be set to **"CoinBridge"**. |
| `iss` | **Issuer** | Must be set to the **Application Key** received from CoinBridge. |
| `sub` | **Subject** | A unique identifier of the logged-in user in your application. |

> **⚠️ Warning:** To protect user privacy, do not use PII (real user ID, phone number, or email) as the `sub` value. CoinBridge systems store this value without special encryption, so you must use an internal, anonymized identifier recognized across your systems.

### Step 3: Call the Authenticate Method
Once your application receives the signed JWT generated by your backend, pass it to the CoinBridge SDK to correlate the user across the platform.

<details> <summary><b>Android (Java)</b></summary>

#### Android Implementation
Use the `authenticate` method from the `CoinBridgeSDK` singleton class:

```java
CoinBridgeSDK.getInstance().authenticate(context, jwt, new OnAuthenticationCallback() {
    @Override
    public void onAuthenticated() {
        // Success: The SDK is associated with the user.
        // Proceed to call the Initialization method.
    }

    @Override
    public void onError(CBError<AuthError> error) {
        // Handle authentication failure.
    }
});
```

</details>

<details> <summary><b>iOS (Swift)</b></summary>

### iOS Implementation
For iOS, use the `authenticate` method within the `CoinBridge` singleton class.


```swift
CoinBridge.sharedInstance.authenticate(jwt: "YOUR_JWT_VALUE") { onAuthenticationCompletion in
    switch onAuthenticationCompletion {
    case .onAuthenticated:
        // Success: The SDK is now associated with the logged-in user.
        // Proceed to call the initialization method.
    case .onError(let authenticateError):
        // Handle authentication failure (e.g., .invalidAuthentication).
    }
}
```
</details>